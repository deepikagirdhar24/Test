public Response createAddress(String strEnvType, String strBearerToken, String strJWTToken,
                              Map<String, String> mapAddressDetails, ScenarioContext scenarioContext) throws Exception {

    String strTYKURL = getTYKURL(strEnvType, "TYK.ADDRESS");
    POJOAddressRequest pojoAddressRequest = payloads.buildAddressPayload(mapAddressDetails, true);
    String strRequestBody = objObjectMapper.writeValueAsString(pojoAddressRequest);

    ExtentCucumberAdapter.addTestStepLog("Sending request to Create Address");

    Response objResponse = sendPostRequest(strTYKURL, strBearerToken, strJWTToken, strRequestBody, null);
    String strResponseBody = devHelperLibrary.getResponseBody(objResponse);
    objCucumberLogger.PrintStatus("Response is: " + strResponseBody);

    String strAddressObjectId = jsonHelper.extractStringField(objResponse, "objectId");
    String strAddressOrderId = jsonHelper.extractStringField(objResponse, "orderId");
    String strAddressUuid = pojoAddressRequest.getStrUuid();

    // Save latest (for backward compatibility)
    scenarioContext.setContext("addressObjectId", strAddressObjectId);
    scenarioContext.setContext("addressOrderId", strAddressOrderId);
    scenarioContext.setContext("addressUuid", strAddressUuid);

    // üîÅ Append to list for multiple address support
    List<String> addressObjectIds = (List<String>) scenarioContext.getOrDefault("addressObjectIds", new ArrayList<>());
    addressObjectIds.add(strAddressObjectId);
    scenarioContext.setContext("addressObjectIds", addressObjectIds);

    return objResponse;
}

@Then("Send request to create multiple Addresses with below details")
public void sendRequestToCreateMultipleAddresses(DataTable dataTable) throws Exception {
    String jwtToken = scenarioContext.getContext("JWTToken");
    List<Map<String, String>> addressRows = dataTable.asMaps(String.class, String.class);

    for (Map<String, String> addressData : addressRows) {
        objAddress.createAddress(strEnvType, "Bearer", jwtToken, addressData, scenarioContext);
    }

    ExtentCucumberAdapter.addTestStepLog("Created multiple addresses. IDs: " +
        scenarioContext.getContext("addressObjectIds"));
}


