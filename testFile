package ICOS;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import commonLibrary.devHelperLibrary;
import config.TestConfig;
import io.restassured.response.Response;
import io.restassured.specification.RequestSpecification;
import utilities.Buffer;
import utilities.CucumberLogger;
import utilities.EncryptionUtil;

import java.awt.*;
import java.util.*;
import java.util.List;

import static io.restassured.RestAssured.with;

public class createContactNotes {
    public ObjectMapper objectMapper;
    public static EncryptionUtil objEncryptionUtil;
    protected TestConfig testDataConfig= TestConfig.getTestDataConfig();

    CucumberLogger objCucumberLogger;
    devHelperLibrary objdevHelperLibrary;

    public static RequestSpecification rspec;
    private static Response response;
    private static String responseBody;
    String TYK_KEY = System.getenv("X-TYK-API-KEY");
    String objectId;
    String orderId;

    public createContactNotes() throws Exception {
        objEncryptionUtil= new EncryptionUtil();
        objectMapper = new ObjectMapper();
        objCucumberLogger= new CucumberLogger();
        objdevHelperLibrary= new devHelperLibrary();
        rspec=objdevHelperLibrary.setup();
    }

    public Response createNewPerson(String strEnvType,String strBearerToken,String strJWTToken, String firstName) throws JsonProcessingException {
        HashMap<String,String> formParams= new HashMap<String,String>();
        String strAuthentication=strBearerToken+" "+strJWTToken;
        objCucumberLogger.PrintStatus("authenticationis"+strAuthentication);
        String strTYKURL=testDataConfig.readApplicationProperty("TYK.ENV."+strEnvType)+testDataConfig.readApplicationProperty("TYK.CREATENEWPERSON");
        objCucumberLogger.PrintStatus("URL is"+strTYKURL);

        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("uuid", UUID.randomUUID().toString().substring(0,7));
        requestBody.put("subType", "pers_form_ass");
        requestBody.put("domiCountry", "CH");
        requestBody.put("firstName", firstName);
        requestBody.put("lastName", "Lastname");
        requestBody.put("gender", "male");

        List<String> nationalities = new ArrayList<>();
        nationalities.add("CH");

        requestBody.put("nationalities", nationalities);

        String jsonBody = new ObjectMapper().writeValueAsString(requestBody);
        objCucumberLogger.PrintStatus(jsonBody);

        response = with().spec(rspec)
                .header("Authorization",strBearerToken+" "+strJWTToken)
                .header("X-TYK-API-KEY",TYK_KEY)
                .header("Content-Type","application/json")
                .body(jsonBody)
                .post(strTYKURL);
        responseBody = objdevHelperLibrary.getResponseBody(response);
        objCucumberLogger.PrintStatus("Status code is"+response.statusCode());
        objectId = response.jsonPath().getString("objectId");
        orderId = response.jsonPath().getString("orderId");
        objCucumberLogger.PrintStatus("Extracted Object Id is"+objectId);
        objCucumberLogger.PrintStatus("Extracted Order Id is"+orderId);
        objCucumberLogger.PrintStatus("Response is"+responseBody);
        return response;
    }

    public Response createContactNote(String strEnvType,String strBearerToken,String strJWTToken) throws JsonProcessingException {
        HashMap<String,String> formParams= new HashMap<String,String>();
        String strAuthentication=strBearerToken+" "+strJWTToken;
        objCucumberLogger.PrintStatus("authenticationis"+strAuthentication);
        String strTYKURL=testDataConfig.readApplicationProperty("TYK.ENV."+strEnvType)+testDataConfig.readApplicationProperty("TYK.CREATENEWPERSON");
        objCucumberLogger.PrintStatus("URL is"+strTYKURL);

        Map<String, Object> requestBody = new HashMap<>();

        List<String> personIds = new ArrayList<>();
        personIds.add(objectId);

        requestBody.put("personIds", personIds);
        requestBody.put("subject", "Testsubject");
        requestBody.put("notes", "Testnote");
        requestBody.put("hasFollowup", false);

        String jsonBody = new ObjectMapper().writeValueAsString(requestBody);
        objCucumberLogger.PrintStatus(jsonBody);

        response = with().spec(rspec)
                .header("Authorization",strBearerToken+" "+strJWTToken)
                .header("X-TYK-API-KEY",TYK_KEY)
                .header("Content-Type","application/json")
                .body(jsonBody)
                .post(strTYKURL);
        responseBody = objdevHelperLibrary.getResponseBody(response);
        objCucumberLogger.PrintStatus("Status code is"+response.statusCode());
        objCucumberLogger.PrintStatus("Response is"+responseBody);
        return response;
    }

}
    @And("Send request to generate New Person with {string}")
    public void sendRequestToGenerateNewPerson(String firstName) throws JsonProcessingException {
        String jwtToken = scenarioContext.getToken("JWTToken");
        response =objpostContactNotes.createNewPerson(strEnvType,"Bearer",jwtToken, firstName);
    }

    @Then("Send POST ContactNote Request")
    public void sendPOSTContactNoteRequest() throws JsonProcessingException {
        String jwtToken = scenarioContext.getToken("JWTToken");
        response =objpostContactNotes.createContactNote(strEnvType,"Bearer",jwtToken);
    }

Feature:  Post Contact Notes API

  Scenario Outline: Verify the Post Contact Notes API
    Given Send Request to get Authentication Token for ICOS
    When I generate the JWT Token
    And Send request to generate New Person with "<FirstName>"
    Then Send POST ContactNote Request
    And I verify the Status Code for Create Contact Notes "<StatusCode>"

    Examples:
      | StatusCode | FirstName   |
      |  200       | FirstName_1 |

[INFO] 
[INFO] --- maven-surefire-plugin:3.0.0-M5:test (default-test) @ wealth-icos-api ---
[INFO] 
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running testRunner.Runner
Scenario Outline: Verify the Post Contact Notes API           # src/test/resources/Features/CreateContactNotes.feature:12
Before All
May 07, 2025 11:30:39 AM hooks.CucumberHooks beforeScenario
INFO: Before Scenario: Test is starting!
May 07, 2025 11:30:47 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Access Token is51kg3ldrd27Izye33FYywaOMwQZz
May 07, 2025 11:30:47 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Access Token  is{accessToken=51kg3ldrd27Izye33FYywaOMwQZz, tokenType=Bearer}
  Given Send Request to get Authentication Token for ICOS     # stepDefinations.GetUserSteps.sendRequestToGetAuthenticationTokenForICOS()
May 07, 2025 11:30:48 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Tyk Token iseyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJzdXAtYW1pd3Mtand0LWdlbmVyYXRvciIsInN1YiI6IlJCU0MkQ0xNX09OQk9BUkRJTkciLCJhdWQiOiJBTUlXZWJTZXJ2aWNlcyIsImV4cCI6MTc0NjYxNDc0OCwiaWF0IjoxNzQ2NjEzODQ4LCJhdmFsb3FfYnVfaWQiOiI2In0.dhuMF53baRlZn_-_dHjvndTSEEywFH5affvHN_rBvY4P4C6pgBqNOxHaWiacwBFfpO_7MLp-3CBRmxubXX0EyH_-LENMshLcCUgm7QARDJWPq5lpfTx1hisp7Rri8tbBgokxbrbhibuSy_QHG4GC929iKdcVMB_aGo7pgCwunw08vvtnDX4M_7xd5jpTP2npjsyJPt2Ct0vhy9xoy5C5W_25uRqGMlE6GyquB2URx0nwY4MHhb2LlhbW-94s0WMg2Pf8oO4I8i4VsaEFj9XypYLsMinE3Wfia7OaVVQSAr2BTMtUdSdOMjF70ihTxwmX72_MMSfEomylsjF9kC6ixQ
  When I generate the JWT Token                               # stepDefinations.GetUserSteps.iGenerateTheJWTToken()
May 07, 2025 11:30:48 AM utilities.CucumberLogger PrintStatus
INFO: Value is: authenticationisBearer eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJzdXAtYW1pd3Mtand0LWdlbmVyYXRvciIsInN1YiI6IlJCU0MkQ0xNX09OQk9BUkRJTkciLCJhdWQiOiJBTUlXZWJTZXJ2aWNlcyIsImV4cCI6MTc0NjYxNDc0OCwiaWF0IjoxNzQ2NjEzODQ4LCJhdmFsb3FfYnVfaWQiOiI2In0.dhuMF53baRlZn_-_dHjvndTSEEywFH5affvHN_rBvY4P4C6pgBqNOxHaWiacwBFfpO_7MLp-3CBRmxubXX0EyH_-LENMshLcCUgm7QARDJWPq5lpfTx1hisp7Rri8tbBgokxbrbhibuSy_QHG4GC929iKdcVMB_aGo7pgCwunw08vvtnDX4M_7xd5jpTP2npjsyJPt2Ct0vhy9xoy5C5W_25uRqGMlE6GyquB2URx0nwY4MHhb2LlhbW-94s0WMg2Pf8oO4I8i4VsaEFj9XypYLsMinE3Wfia7OaVVQSAr2BTMtUdSdOMjF70ihTxwmX72_MMSfEomylsjF9kC6ixQ
May 07, 2025 11:30:48 AM utilities.CucumberLogger PrintStatus
INFO: Value is: URL ishttps://tyk-gateway.tadpole.uat01-fds.wealth.banksvcs.net/avq/acpr/sas-person/v1/natural-persons
May 07, 2025 11:30:48 AM utilities.CucumberLogger PrintStatus
INFO: Value is: {"firstName":"FirstName_1","lastName":"Lastname","domiCountry":"CH","gender":"male","subType":"pers_form_ass","nationalities":["CH"],"uuid":"677d221"}
May 07, 2025 11:30:51 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Status code is200
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Extracted Object Id is665078413
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Extracted Order Id is2864378091
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Response is{"objectId":"665078413","orderId":"2864378091"}
  And Send request to generate New Person with "FirstName_1"  # stepDefinations.CreateContactSteps.sendRequestToGenerateNewPerson(java.lang.String)
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: authenticationisBearer eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJzdXAtYW1pd3Mtand0LWdlbmVyYXRvciIsInN1YiI6IlJCU0MkQ0xNX09OQk9BUkRJTkciLCJhdWQiOiJBTUlXZWJTZXJ2aWNlcyIsImV4cCI6MTc0NjYxNDc0OCwiaWF0IjoxNzQ2NjEzODQ4LCJhdmFsb3FfYnVfaWQiOiI2In0.dhuMF53baRlZn_-_dHjvndTSEEywFH5affvHN_rBvY4P4C6pgBqNOxHaWiacwBFfpO_7MLp-3CBRmxubXX0EyH_-LENMshLcCUgm7QARDJWPq5lpfTx1hisp7Rri8tbBgokxbrbhibuSy_QHG4GC929iKdcVMB_aGo7pgCwunw08vvtnDX4M_7xd5jpTP2npjsyJPt2Ct0vhy9xoy5C5W_25uRqGMlE6GyquB2URx0nwY4MHhb2LlhbW-94s0WMg2Pf8oO4I8i4VsaEFj9XypYLsMinE3Wfia7OaVVQSAr2BTMtUdSdOMjF70ihTxwmX72_MMSfEomylsjF9kC6ixQ
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: URL ishttps://tyk-gateway.tadpole.uat01-fds.wealth.banksvcs.net/avq/acpr/sas-person/v1/natural-persons
May 07, 2025 11:30:54 AM utilities.CucumberLogger PrintStatus
INFO: Value is: {"notes":"Testnote","subject":"Testsubject","hasFollowup":false,"personIds":["665078413"]}
May 07, 2025 11:30:55 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Status code is500
May 07, 2025 11:30:55 AM utilities.CucumberLogger PrintStatus
INFO: Value is: Response is{"orderId":null,"error":"Mandatory: Name"}
  Then Send POST ContactNote Request                          # stepDefinations.CreateContactSteps.sendPOSTContactNoteRequest()
  And I verify the Status Code for Create Contact Notes "200" # stepDefinations.CreateContactSteps.iVerifyTheStatusCodeForCreateContactNotes(java.lang.String)
      java.lang.AssertionError: expected [500] but found [200]
	at org.testng.Assert.fail(Assert.java:111)
	at org.testng.Assert.failNotEquals(Assert.java:1578)
	at org.testng.Assert.assertEqualsImpl(Assert.java:150)
	at org.testng.Assert.assertEquals(Assert.java:132)
	at org.testng.Assert.assertEquals(Assert.java:1419)
	at org.testng.Assert.assertEquals(Assert.java:1383)
	at org.testng.Assert.assertEquals(Assert.java:1429)
	at stepDefinations.CreateContactSteps.iVerifyTheStatusCodeForCreateContactNotes(CreateContactSteps.java:91)
	at âœ½.I verify the Status Code for Create Contact Notes "200"(file:///C:/Users/girdd/IdeaProjects/icosapitests/src/test/resources/Features/CreateContactNotes.feature:8)
May 07, 2025 11:30:58 AM tech.grasshopper.pdf.PDFCucumberReport collectReportConfiguration
INFO: PDF report configuration YAML file not found. Using default settings.
[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 23.974 s <<< FAILURE! - in testRunner.Runner
[ERROR] Post Contact Notes API.Verify the Post Contact Notes API  Time elapsed: 18.703 s  <<< FAILURE!
java.lang.AssertionError: expected [500] but found [200]
[INFO] 
[INFO] Results:
[INFO] 
[ERROR] Failures: 
[ERROR]   expected [500] but found [200]
[INFO] 
[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0
[INFO] 
