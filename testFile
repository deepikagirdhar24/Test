package ICOS;

import ICOS.pojo.NewPersonRequest;
import com.aventstack.extentreports.cucumber.adapter.ExtentCucumberAdapter;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import commonLibrary.devHelperLibrary;
import config.TestConfig;
import io.restassured.response.Response;
import utilities.CucumberLogger;
import utilities.EncryptionUtil;
import utilities.Payloads;
import utilities.ScenarioContext;

import java.util.HashMap;
import java.util.Map;

public class NaturalPerson extends BaseApiClient {

    private ObjectMapper objObjectMapper;
    private CucumberLogger objCucumberLogger;
    private EncryptionUtil objEncryptionUtil;

    public NaturalPerson() throws Exception {
        objObjectMapper = new ObjectMapper();
        objCucumberLogger = new CucumberLogger();
        objEncryptionUtil = new EncryptionUtil();
    }

    // Create Natural Person
    public Response createNewPerson(String strEnvType, String strBearerToken, String strJwtToken, Map<String, String> mapPersonDetails, ScenarioContext scenarioContext) throws JsonProcessingException {
        String strUrl = getTYKURL(strEnvType, "TYK.CREATENEWPERSON");
        NewPersonRequest pojoNewPersonRequest = Payloads.buildNewPersonPayload(mapPersonDetails);
        String strRequestBody = objObjectMapper.writeValueAsString(pojoNewPersonRequest);

        ExtentCucumberAdapter.addTestStepLog("Sending request to create Natural Person");

        Response resCreatePerson = sendPostRequest(strUrl, strBearerToken, strJwtToken, strRequestBody, null);
        String strResponseBody = devHelperLibrary.getResponseBody(resCreatePerson);
        objCucumberLogger.PrintStatus("Response is: " + strResponseBody);

        String strNaturalPersonObjectId = resCreatePerson.jsonPath().getString("objectId");
        String strNaturalPersonOrderId = resCreatePerson.jsonPath().getString("orderId");
        String strNaturalPersonUuid = pojoNewPersonRequest.getStrUuid();

        scenarioContext.setContext("naturalPersonObjectId", strNaturalPersonObjectId);
        scenarioContext.setContext("naturalPersonOrderId", strNaturalPersonOrderId);
        scenarioContext.setContext("naturalPersonUuid", strNaturalPersonUuid);

        return resCreatePerson;
    }

    // Get Natural Person
    public Response getNaturalPerson(String strEnvType, String strBearerToken, String strJwtToken, ScenarioContext scenarioContext) {
        String strUrl = getTYKURL(strEnvType, "TYK.CREATENEWPERSON") + "/{id}";
        String strNaturalPersonObjectId = scenarioContext.getContext("naturalPersonObjectId");
        String strNaturalPersonUuid = scenarioContext.getContext("naturalPersonUuid");

        Map<String, String> mapPathParams = new HashMap<>();
        mapPathParams.put("id", strNaturalPersonObjectId);

        Map<String, String> mapQueryParams = new HashMap<>();
        mapQueryParams.put("uuid", strNaturalPersonUuid);
        mapQueryParams.put("minimal", "yes");

        ExtentCucumberAdapter.addTestStepLog("Sending GET request for Natural Person");

        Response resGetPerson = sendGetRequest(strUrl, strBearerToken, strJwtToken, mapPathParams, mapQueryParams);
        String strResponseBody = devHelperLibrary.getResponseBody(resGetPerson);
        objCucumberLogger.PrintStatus("Response is: " + strResponseBody);

        return resGetPerson;
    }

    // Create Natural Person Order
    public Response createNaturalPersonOrder(String strEnvType, String strBearerToken, String strJwtToken,
                                        Map<String, String> mapPersonDetails, ScenarioContext scenarioContext) throws JsonProcessingException {
        String strUrl = getTYKURL(strEnvType, "TYK.CREATENEWPERSON");
        String strNaturalPersonOrderId = scenarioContext.getContext("naturalPersonOrderId");

        NewPersonRequest pojoNewPersonRequest = Payloads.buildNewPersonPayload(mapPersonDetails);
        String strRequestBody = objObjectMapper.writeValueAsString(pojoNewPersonRequest);

        Map<String, String> mapQueryParams = new HashMap<>();
        mapQueryParams.put("order", strNaturalPersonOrderId);

        ExtentCucumberAdapter.addTestStepLog("Sending PATCH request to create Natural Person Order");

        Response resUpdatePerson = sendPatchRequest(strUrl, strBearerToken, strJwtToken, strRequestBody, mapQueryParams);
        String strResponseBody = devHelperLibrary.getResponseBody(resUpdatePerson);
        objCucumberLogger.PrintStatus("Response is: " + strResponseBody);

        return resUpdatePerson;
    }
}
